<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Javascript Integration Tests Coverage With Istanbul | My Life as a Developer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="We’ve all heard about the importance of tests. Especially in javascript when even a minor code refactoring is becoming an issue because of the dynamic nature of the language.
But even if the project h">
<meta property="og:type" content="article">
<meta property="og:title" content="Javascript Integration Tests Coverage With Istanbul">
<meta property="og:url" content="http://noamsh.com/2014/07/05/integration-coverage-istanbul/">
<meta property="og:site_name" content="My Life as a Developer">
<meta property="og:description" content="We’ve all heard about the importance of tests. Especially in javascript when even a minor code refactoring is becoming an issue because of the dynamic nature of the language.
But even if the project h">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Javascript Integration Tests Coverage With Istanbul">
<meta name="twitter:description" content="We’ve all heard about the importance of tests. Especially in javascript when even a minor code refactoring is becoming an issue because of the dynamic nature of the language.
But even if the project h">
<meta name="twitter:creator" content="@[object Object]">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-52398580-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">My Life as a Developer</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">node, angular, etc...</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://noamsh.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-integration-coverage-istanbul" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/07/05/integration-coverage-istanbul/" class="article-date">
  <time datetime="2014-07-05T11:20:13.000Z" itemprop="datePublished">05 07 2014</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Nodejs/">Node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Javascript Integration Tests Coverage With Istanbul
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>We’ve all heard about the importance of tests. Especially in javascript when even a minor code refactoring is becoming an issue because of the dynamic nature of the language.</p>
<p>But even if the project has a lot of tests, we’re not sure if every line in the code is covered. That’s where coverage tools come in handy.</p>
<p>What is the problem then? While running coverage for unit tests is pretty easy and works out of the box (e.g. <a href="http://blanketjs.org" title="Blanket.js" target="_blank" rel="external">blanket.js</a>), coverage for integration tests is a bit harder, because the tool doesn’t know what is the code that is being tested.</p>
<p><a id="more"></a>It took me a few hours to realize that <a href="https://github.com/gotwarlost/istanbul" title="istanbul" target="_blank" rel="external">Istanbul</a> already solved this problem, they are giving the option to instrument code, although the documentation about this feature is pretty shallow. Maybe this post will help if you encounter the same issue.</p>
<p>Instrumenting your code is to convert your source code to a code with coverage data, so the coverage tool will be able to generate a report with the relevant coverage.</p>
<p>In order to get the report for all of our tests, assuming the unit tests and the integration tests are in the same folder, run the following:</p>
<ol>
<li><p>Instrument your core source code + the tests source code</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>istanbul instrument . -o <span class="preprocessor">.instrument</span>
</pre></td></tr></table></figure>
</li>
<li><p>Run the server with istanbul cover</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>istanbul <span class="keyword">cover</span> <span class="comment">--report none [main-file.js]</span>
</pre></td></tr></table></figure>

<p>Additional parameters can be added after two dashes:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>istanbul cover --report <span class="attribute">none</span> <span class="attr_selector">[.instrument/main-file.js]</span> -- <span class="attr_selector">[params]</span>
</pre></td></tr></table></figure>
</li>
<li><p>Run the tests -</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="comment">istanbul</span> <span class="comment">cover</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">report</span> <span class="comment">none</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">dir</span> <span class="comment">coverage/unit</span> <span class="comment">node_modules/</span><span class="string">.</span><span class="comment">bin/_mocha</span> <span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="comment">R</span> <span class="comment">spec</span> <span class="title">[</span><span class="string">.</span><span class="comment">/instrument/tests</span> <span class="comment">folder</span><span class="title">]</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">recursive</span>
</pre></td></tr></table></figure>
</li>
<li><p>Generate the report</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>istanbul <span class="keyword">report</span>
</pre></td></tr></table></figure>

</li>
</ol>
<p>On the first step, we instrumented the code into a special folder called <code>.instrument</code>. Later on the second one, we just ran the <em>instrumented</em> server code.</p>
<p>The third step is interesting, here we executed all of the project tests, including unit tests, integration tests and system tests, assuming that all of them are in the same folder. If they are not, you can run this step for each tests folder, but make sure that the output of the coverage will be different (<code>--dir coverage/unit</code> parameter).<br>Notice the underscore before mocha, that’s because the regular mocha forks _mocha that and detaches the coverage tool. <a href="https://github.com/gotwarlost/istanbul/issues/44#issuecomment-16093330" title="_mocha vs mocha" target="_blank" rel="external">More about this issue</a>.<br>The two dashes are as before, the values after them are the parameters to the executed command.</p>
<p>On the last step, we generated the report, the magic here is that istanbul knows to take all the files that matched the pattern <code>**/coverage*.json</code> (<a href="https://github.com/gotwarlost/istanbul/blob/master/lib/command/report.js" title="Istanbul source code" target="_blank" rel="external">from the source here</a>).</p>
<p>Happy Coveraging!<br>Noam.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://noamsh.com/2014/07/05/integration-coverage-istanbul/" data-id="v4t2djbp92ef4mql" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2014/06/13/how-to-create-a-data-cluster-and-live-through-it/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">How to Create a Data Cluster and Live Through It</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Angularjs/">Angular.js</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Angularjs/Nodejs/">Node.js</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nodejs/">Node.js</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Draggable-div/">Draggable div</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Google-maps-overlay/">Google maps overlay</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Update-content-with-drag/">Update content with drag</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Draggable-div/" style="font-size: NaNpx;">Draggable div</a><a href="/tags/Google-maps-overlay/" style="font-size: NaNpx;">Google maps overlay</a><a href="/tags/Update-content-with-drag/" style="font-size: NaNpx;">Update content with drag</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2014/07/05/integration-coverage-istanbul/">Javascript Integration Tests Coverage With Istanbul</a>
          </li>
        
          <li>
            <a href="/2014/06/13/how-to-create-a-data-cluster-and-live-through-it/">How to Create a Data Cluster and Live Through It</a>
          </li>
        
          <li>
            <a href="/2014/01/04/sqlite-dal-for-android/">Sq Lite Dal for Android</a>
          </li>
        
          <li>
            <a href="/2013/09/20/google-maps-angular-and-draggable-frame/">Google Maps, Angular and Draggable Frame</a>
          </li>
        
          <li>
            <a href="/2013/08/30/login-and-cookies/">Login and Cookies on Android</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2014 Noam Shemesh<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>
  </div>
</body>
</html>