<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>How to Create a Data Cluster and Live Through It | My Life as a Developer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="This post originally posted at BigPanda’s Blog, BigPanda is the cool start-up company that I currently work at, you can find more about how it manages alerts and fights the alert fatigue here.
As the">
<meta property="og:type" content="article">
<meta property="og:title" content="How to Create a Data Cluster and Live Through It">
<meta property="og:url" content="http://noamsh.com/2014/06/13/how-to-create-a-data-cluster-and-live-through-it/">
<meta property="og:site_name" content="My Life as a Developer">
<meta property="og:description" content="This post originally posted at BigPanda’s Blog, BigPanda is the cool start-up company that I currently work at, you can find more about how it manages alerts and fights the alert fatigue here.
As the">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="How to Create a Data Cluster and Live Through It">
<meta name="twitter:description" content="This post originally posted at BigPanda’s Blog, BigPanda is the cool start-up company that I currently work at, you can find more about how it manages alerts and fights the alert fatigue here.
As the">
<meta name="twitter:creator" content="@[object Object]">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-52398580-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">My Life as a Developer</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">node, angular, etc...</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://noamsh.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-how-to-create-a-data-cluster-and-live-through-it" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/06/13/how-to-create-a-data-cluster-and-live-through-it/" class="article-date">
  <time datetime="2014-06-13T15:17:01.000Z" itemprop="datePublished">13 06 2014</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Nodejs/">Node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      How to Create a Data Cluster and Live Through It
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>This post originally posted at <a href="http://bit.ly/1v4ycZY" title="BigPanda" target="_blank" rel="external">BigPanda’s Blog</a>, BigPanda is the cool start-up company that I currently work at, you can find more about how it manages alerts and fights the alert fatigue <a href="http://bigpanda.io" title="BigPanda" target="_blank" rel="external">here</a>.</p>
<p>As the world of software development is moving to <a href="http://bigpanda.io" title="BigPanda" target="_blank" rel="external">BigPanda</a>, ahmm… sorry, I meant Big Data, we need to pay attention to synchronization, and it’s becoming one of the most difficult challenges we face.</p>
<p>Here at BigPanda, we receive a lot of alerts from <a href="http://bigpanda.io/integrations/" target="_blank" rel="external">many monitoring systems</a>, and naturally we want to keep the data synchronized and consistent. One issue we face is when a server is reported by a monitoring system as <strong>DOWN</strong>, and then, one moment later is reported as <strong>UP</strong>. We need the two events to be processed in relation to the same server and in the correct order, to ensure the status does not end up being <strong>DOWN</strong>.</p>
<p><a id="more"></a>Our data cluster was written because we wanted to synchronize the data in our back-end applications, and not in the database itself. We believe this is a better approach for several reasons:</p>
<ul>
<li><em>Vendor independence</em> - Today we use <a href="http://www.mongodb.org" title="mongodb" target="_blank" rel="external">MongoDB</a>, but our needs and the database may change in the future.</li>
<li><em>Control</em> - Sharding complex data entities across servers is difficult without understanding the application-level entities. We know the entities, but MongoDB, <a href="http://cassandra.apache.org" title="Cassanda" target="_blank" rel="external">Cassandra</a> or <a href="http://hbase.apache.org" title="HBase" target="_blank" rel="external">HBase</a> don’t.</li>
<li><em>Synchronization</em> - As described above, we need to process correctly two updates for the same entity that occur at the same time.</li>
</ul>
<h4 id="Our_Solution:_Frodo-io">Our Solution: Frodo.io</h4>
<p>To address this challenge we developed Frodo.io (Github: <a href="https://github.com/bigpandaio/frodo" target="_blank" rel="external">https://github.com/bigpandaio/frodo</a>). Frodo.io exposes an easy to use API that allows you to easily synchronize distributed backends. It returns the server by entity details, and ensures it will always return the same server for a given ID. Frodo orchestrates <strong><a href="https://github.com/coreos/etcd" title="etcd" target="_blank" rel="external">etcd</a></strong> and <strong><a href="https://github.com/3rd-Eden/node-hashring" title="hashring" target="_blank" rel="external">hashring</a>.</strong></p>
<p><strong>etcd</strong> - is <em>a highly-available key value store for shared configuration and service discovery</em> (from <a href="https://github.com/coreos/etcd/blob/master/README.md" title="etcd" target="_blank" rel="external">etcd’s README</a>)</p>
<p><strong>hashring</strong> - is a consistent hashing algorithm implementation. The hashing algorithm is optimized so that when the hash table is resized, the number of keys that it needs to migrate is relatively small.</p>
<p>Let’s look at an example in which we’re initializing frodo, adding 3 servers to the ring, retrieving the server that should be in use for this id and making a REST request to the server:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>var Frodo = require('frodoio');
var frodo = new Frodo({ context: 'appname', etcdServers: [ { host: '127.0.0.1', port: 4001 } ]});
Q.all(frodo.addServer('dataacess1:3030'),
  frodo.addServer('dataacess2:3030'),
  frodo.addServer('dataacess3:3030')).then(function () {
    frodo.serverById('someId', function (server)
      request.put('http://' + server + '/entity');
    });
  });
</pre></td></tr></table></figure>

<p><em>Note: don’t forget to </em><code>npm install frodoio</code><em> and </em><code>npm install q</code><em> in order to run this code snippet</em></p>
<p>No matter how many times you will make a call to a server, as long as the server list is the same, you’ll consistently get the same server for the same id!</p>
<p>In the following, more comprehensive, example, we separate the server code from the client code. Every server in the data cluster registers itself in frodo.io. In the client we’re requesting a server to handle a specific entity and then calling a url on that server.</p>
<h5 id="Server:">Server:</h5>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="keyword">var</span> Frodo = <span class="built_in">require</span>(<span class="string">'frodoio'</span>);
<span class="keyword">var</span> frodo = <span class="keyword">new</span> Frodo({ context: <span class="string">'appname'</span>, etcdServers: [ { host: <span class="string">'127.0.0.1'</span>, port: <span class="number">4001</span> } ]});

<span class="comment">// http://stackoverflow.com/questions/3653065/get-local-ip-address-in-node-js</span>
<span class="keyword">var</span> ip = _.chain(<span class="built_in">require</span>(<span class="string">'os'</span>).networkInterfaces()).flatten().filter(<span class="function"><span class="keyword">function</span><span class="params">(val)</span>{</span> <span class="keyword">return</span> (val.family == <span class="string">'IPv4'</span> &amp;&amp; val.internal == <span class="literal">false</span>) }).pluck(<span class="string">'address'</span>).first().value();
<span class="keyword">var</span> me = ip + <span class="string">':3030'</span>;

<span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">(done)</span> {</span>
  frodo.addServer(me).then(done);
}

<span class="function"><span class="keyword">function</span> <span class="title">stop</span><span class="params">(done)</span> {</span>
  frodo.removeServer(me).then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    frodo.close().then(done);
  });
}
</pre></td></tr></table></figure>

<p>In the first two lines we are initializing frodo with the etcd config and a <code>context</code> for the application (usually just your app name). Then we fetch the IP of the current server.<br>The <code>start</code> and <code>stop</code> functions are “listeners” and your application should call them when it starts or stops.</p>
<h5 id="Client:">Client:</h5>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="keyword">var</span> Frodo = <span class="built_in">require</span>(<span class="string">'frodoio'</span>);
<span class="keyword">var</span> frodo = <span class="keyword">new</span> Frodo({ context: <span class="string">'appname'</span>, etcdServers: [ { host: <span class="string">'127.0.0.1'</span>, port: <span class="number">4001</span> } ]});

frodo.serverById(id).then(<span class="function"><span class="keyword">function</span> <span class="params">(server)</span> {</span>
  request.put(<span class="string">'http://'</span> + server + <span class="string">'/entity'</span>);
});
</pre></td></tr></table></figure>

<p>After initialization, we request the server by an <code>id</code>, just like in the previous example.</p>
<p>Try to run at least two instances of the server, and then run the clients repeatedly with the same id to get the same server and with different ids to get different servers. The entities are evenly distributed with <strong>hashring</strong>.</p>
<p>For more information about Frodo’s capabilities and the API, please go to <a href="https://github.com/bigpandaio/frodo" title="frodo.io" target="_blank" rel="external">frodo’s github homepage</a>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://noamsh.com/2014/06/13/how-to-create-a-data-cluster-and-live-through-it/" data-id="z5tssnl8ph4jd18d" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/07/05/integration-coverage-istanbul/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Javascript Integration Tests Coverage With Istanbul
        
      </div>
    </a>
  
  
    <a href="/2014/01/04/sqlite-dal-for-android/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Sq Lite Dal for Android</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Angularjs/">Angular.js</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Angularjs/Nodejs/">Node.js</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nodejs/">Node.js</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Draggable-div/">Draggable div</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Google-maps-overlay/">Google maps overlay</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Update-content-with-drag/">Update content with drag</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Draggable-div/" style="font-size: NaNpx;">Draggable div</a><a href="/tags/Google-maps-overlay/" style="font-size: NaNpx;">Google maps overlay</a><a href="/tags/Update-content-with-drag/" style="font-size: NaNpx;">Update content with drag</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2014/07/05/integration-coverage-istanbul/">Javascript Integration Tests Coverage With Istanbul</a>
          </li>
        
          <li>
            <a href="/2014/06/13/how-to-create-a-data-cluster-and-live-through-it/">How to Create a Data Cluster and Live Through It</a>
          </li>
        
          <li>
            <a href="/2014/01/04/sqlite-dal-for-android/">Sq Lite Dal for Android</a>
          </li>
        
          <li>
            <a href="/2013/09/20/google-maps-angular-and-draggable-frame/">Google Maps, Angular and Draggable Frame</a>
          </li>
        
          <li>
            <a href="/2013/08/30/login-and-cookies/">Login and Cookies on Android</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2014 Noam Shemesh<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>
  </div>
</body>
</html>