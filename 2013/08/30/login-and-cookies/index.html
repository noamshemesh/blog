<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Login and Cookies on Android | My Life as a Developer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="If you ever tried to work with cookies and Android you know that it isn’t covered well over the net.
The log-in screen, however, is more covered, there are many templates all over the net, but we coul">
<meta property="og:type" content="article">
<meta property="og:title" content="Login and Cookies on Android">
<meta property="og:url" content="http://noamsh.com/2013/08/30/login-and-cookies/">
<meta property="og:site_name" content="My Life as a Developer">
<meta property="og:description" content="If you ever tried to work with cookies and Android you know that it isn’t covered well over the net.
The log-in screen, however, is more covered, there are many templates all over the net, but we coul">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Login and Cookies on Android">
<meta name="twitter:description" content="If you ever tried to work with cookies and Android you know that it isn’t covered well over the net.
The log-in screen, however, is more covered, there are many templates all over the net, but we coul">
<meta name="twitter:creator" content="@[object Object]">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-52398580-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">My Life as a Developer</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">node, angular, etc...</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://noamsh.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-login-and-cookies" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2013/08/30/login-and-cookies/" class="article-date">
  <time datetime="2013-08-30T08:44:57.000Z" itemprop="datePublished">30 08 2013</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Login and Cookies on Android
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>If you ever tried to work with cookies and Android you know that it isn’t covered well over the net.</p>
<p>The log-in screen, however, is more covered, there are many templates all over the net, but we couldn’t find a template that covers the flow from A to Z, with cookies and result code handling.</p>
<p>That’s the motivation. Now for the good part:</p>
<p><a id="more"></a>Let’s start with architecture, we are going to use cookies to save the credentials of the user by the server in his device. Just as websites do. Also, one of the requirements is that the user will log-in only when he has to (think about <a href="http://www.ebay.com" target="_blank" rel="external">eBay </a> purchasing process), so we have to handle the 401 HTTP code from node.js when the user has no cookie or cookie credentials are incorrect, and not just open for him the <code>LoginActivity</code> on start.</p>
<p>For the authentication and credentials management parts we forked <a href="https://github.com/fnakstad/angular-client-side-auth" target="_blank" rel="external">angular-client-side-auth</a> that pretty covered up all the node.js and Angular.js log-in and registration flow, and we wanted the same for android.</p>
<p>When apache HTTP client was the option, it didn’t know how to persist cookies, so we serialized them into a <code>SharedPreferences</code> object, it’s probably not the best solution as it was buggy as hell and a lot of code to write.</p>
<p>Then <a href="http://loopj.com/android-async-http/" target="_blank" rel="external">loopj asynchronous http client library</a> came up, this great library knows how to persist cookies with just 2 lines of code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre>PersistentCookieStore cookieStore = <span class="keyword">new</span> PersistentCookieStore(<span class="keyword">this</span>);
httpClient.setCookieStore(cookieStore);
</pre></td></tr></table></figure>

<p>Cookie issue faded away.</p>
<p>Besides cookies, there is result code handle, if it’s 401 we send the user to the <code>LoginActivity.</code> Then, according to implementation, the app can post/get the url again:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span>(<span class="keyword">final</span> Throwable t, <span class="keyword">final</span> String message) {
	<span class="keyword">new</span> AsyncTask&lt;Void, Void, Void&gt;() {
		<span class="annotation">@Override</span>
		<span class="keyword">protected</span> Void <span class="title">doInBackground</span>(Void... params) {
			<span class="keyword">return</span> <span class="keyword">null</span>;
		}

		<span class="annotation">@Override</span>
		<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span>(Void result) {
			<span class="keyword">if</span> (t <span class="keyword">instanceof</span> HttpResponseException) {
				<span class="keyword">int</span> responseCode = ((HttpResponseException) t).getStatusCode();
				<span class="keyword">if</span> (responseCode == <span class="number">401</span>) {
					commonPool.handleUnauthorize();
				} <span class="keyword">else</span> {
					String msg = responseCode + &quot;: &quot; + t.getMessage() + &quot; &quot; + message;
					Log.e(TAG, msg);
					onFailure.doCallback(msg);
				}
			}
		}
	}.execute();
}
</pre></td></tr></table></figure>

<p>The <code>AsyncTask</code> is because we want to run the <code>startActivity</code> on the UI thread.</p>
<p>Here is the code for POST one object and return one object and GET and return one object. <code>CommonPool</code> is the <code>Application</code> of the project.</p>
<figure class="highlight java"><figcaption><span>ServerUtils</span></figcaption><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
</pre></td><td class="code"><pre>
<span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerUtils</span> {</span>
	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = ServerUtils.class.getSimpleName();
	<span class="keyword">private</span> <span class="keyword">static</span> AsyncHttpClient httpclient;
	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APPLICATION_JSON = &quot;application/json&quot;;
	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TEXT_PLAIN = &quot;text/plain&quot;;
	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CHARSET = &quot;UTF-<span class="number">8</span>&quot;;

	<span class="keyword">private</span> <span class="keyword">static</span> Gson gson = <span class="keyword">new</span> GsonBuilder().create();

	<span class="keyword">private</span> <span class="title">ServerUtils</span>() {
	}

	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initClient</span>(CommonPool commonPool) {
		<span class="keyword">if</span> (httpclient != <span class="keyword">null</span>) {
			<span class="keyword">return</span>;
		}
		httpclient = <span class="keyword">new</span> AsyncHttpClient();
		PersistentCookieStore cookieStore = <span class="keyword">new</span> PersistentCookieStore(commonPool);
		httpclient.setCookieStore(cookieStore);
	}

	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onPreExecute</span>(CommonPool commonPool) {
		initClient(commonPool);
		httpclient.setTimeout(Constants.DEFAULT_SERVER_TIMEOUT);
	}

	<span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">void</span> <span class="title">get</span>(CommonPool commonPool, String url, <span class="keyword">final</span> Callback onCallback, <span class="keyword">final</span> Callback onFailure,
			<span class="keyword">final</span> Class clazz) {
		onPreExecute(commonPool);
		httpclient.get(url, getOneObjectJson(onCallback, clazz, commonPool, onFailure));
	}

	<span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">void</span> <span class="title">post</span>(<span class="keyword">final</span> CommonPool commonPool, String url, <span class="keyword">final</span> Object object,
			<span class="keyword">final</span> Callback onCallback, <span class="keyword">final</span> Callback onFailure, <span class="keyword">final</span> Class clazz) {
		<span class="keyword">try</span> {
			onPreExecute(commonPool);
			httpclient.post(commonPool, url, <span class="keyword">new</span> StringEntity(gson.toJson(object), CHARSET),
					getContentType(object),
					getOneObjectJson(onCallback, clazz, commonPool, onFailure));
		} <span class="keyword">catch</span> (UnsupportedEncodingException e) {
			<span class="comment">// Can't happen.</span>
			Log.e(TAG, e.getMessage());
		}
	}

	<span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getContentType</span>(<span class="keyword">final</span> Object object) {
		<span class="keyword">return</span> object == <span class="keyword">null</span> || object <span class="keyword">instanceof</span> String ? TEXT_PLAIN : APPLICATION_JSON;
	}

	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJsonHttpResponseHandler</span> <span class="keyword">extends</span> <span class="title">JsonHttpResponseHandler</span> {</span>
		<span class="keyword">private</span> Callback onFailure;
		<span class="keyword">private</span> CommonPool commonPool;

		<span class="keyword">public</span> <span class="title">MyJsonHttpResponseHandler</span>(CommonPool commonPool, Callback onFailure) {
			<span class="keyword">this</span>.commonPool = commonPool;
			<span class="keyword">this</span>.onFailure = onFailure;
		}

		<span class="annotation">@Override</span>
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span>(Throwable t, JSONArray jsonArray) {
			onFailure(t, jsonArray != <span class="keyword">null</span> ? jsonArray.toString() : &quot;&quot;);
		}

		<span class="annotation">@Override</span>
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span>(Throwable t, JSONObject json) {
			onFailure(t, json != <span class="keyword">null</span> ? json.toString() : &quot;&quot;);
		}

		<span class="annotation">@Override</span>
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span>(<span class="keyword">final</span> Throwable t, <span class="keyword">final</span> String message) {
			<span class="keyword">new</span> AsyncTask&lt;Void, Void, Void&gt;() {
				<span class="annotation">@Override</span>
				<span class="keyword">protected</span> Void <span class="title">doInBackground</span>(Void... params) {
					<span class="keyword">return</span> <span class="keyword">null</span>;
				}

				<span class="annotation">@Override</span>
				<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span>(Void result) {
					<span class="keyword">if</span> (t <span class="keyword">instanceof</span> HttpResponseException) {
						<span class="keyword">int</span> responseCode = ((HttpResponseException) t).getStatusCode();
						<span class="keyword">if</span> (responseCode == <span class="number">401</span>) {
							commonPool.handleUnauthorize();
						} <span class="keyword">else</span> {
							String msg = responseCode + &quot;: &quot; + t.getMessage() + &quot; &quot; + message;
							Log.e(TAG, msg);
							onFailure.doCallback(msg);
						}
					}
				}
			}.execute();
		}
	}

	<span class="keyword">private</span> <span class="keyword">static</span>  JsonHttpResponseHandler <span class="title">getOneObjectJson</span>(<span class="keyword">final</span> Callback onCallback, <span class="keyword">final</span> Class clazz,
			CommonPool commonPool, Callback onFailure) {
		<span class="keyword">return</span> <span class="keyword">new</span> MyJsonHttpResponseHandler(commonPool, onFailure) {
			<span class="annotation">@Override</span>
			<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span>(<span class="keyword">int</span> reponseCode, JSONObject json) {
				onCallback.doCallback(gson.fromJson(json.toString(), clazz));
			}

			<span class="annotation">@SuppressWarnings</span>(&quot;unchecked&quot;)
			<span class="annotation">@Override</span>
			<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span>(<span class="keyword">int</span> responseCode, String response) {
				<span class="keyword">if</span> (clazz == <span class="keyword">null</span> || clazz.isAssignableFrom(String.class)) {
					onCallback.doCallback((T) response);
				} <span class="keyword">else</span> {
					onFailure(<span class="keyword">new</span> IllegalArgumentException(&quot;clazz&quot;), response);
				}
			}
		};
	}

	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toJson</span>(Object obj) {
		<span class="keyword">return</span> gson.toJson(obj);
	}

	<span class="keyword">public</span> <span class="keyword">static</span>  T <span class="title">fromJson</span>(String json, Class clazz) {
		<span class="keyword">return</span> gson.fromJson(json, clazz);
	}
}
</pre></td></tr></table></figure>

<p>A reasonable parameter to these 2 methods could be a boolean that tells if send to login screen if not logged in, or just return null, that’s for some calls that will happen before the critical section that require the login (register <a href="https://developer.android.com/google/gcm/gs.html" target="_blank" rel="external">GCM</a> key for example).</p>
<p>Although it may ended up with pretty straight forward code, the way to it wasn’t, I hope it will help someone out there.</p>
<p>Noam.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://noamsh.com/2013/08/30/login-and-cookies/" data-id="ketjigombgpepjyx" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2013/09/20/google-maps-angular-and-draggable-frame/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Google Maps, Angular and Draggable Frame
        
      </div>
    </a>
  
  
    <a href="/2013/08/24/intro/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">(Node|Angular|Myself) Intro</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Angularjs/">Angular.js</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Angularjs/Nodejs/">Node.js</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nodejs/">Node.js</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Draggable-div/">Draggable div</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Google-maps-overlay/">Google maps overlay</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Update-content-with-drag/">Update content with drag</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Draggable-div/" style="font-size: NaNpx;">Draggable div</a><a href="/tags/Google-maps-overlay/" style="font-size: NaNpx;">Google maps overlay</a><a href="/tags/Update-content-with-drag/" style="font-size: NaNpx;">Update content with drag</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2014/07/05/integration-coverage-istanbul/">Javascript Integration Tests Coverage With Istanbul</a>
          </li>
        
          <li>
            <a href="/2014/06/13/how-to-create-a-data-cluster-and-live-through-it/">How to Create a Data Cluster and Live Through It</a>
          </li>
        
          <li>
            <a href="/2014/01/04/sqlite-dal-for-android/">Sq Lite Dal for Android</a>
          </li>
        
          <li>
            <a href="/2013/09/20/google-maps-angular-and-draggable-frame/">Google Maps, Angular and Draggable Frame</a>
          </li>
        
          <li>
            <a href="/2013/08/30/login-and-cookies/">Login and Cookies on Android</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2014 Noam Shemesh<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>
  </div>
</body>
</html>