<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Google Maps, Angular and Draggable Frame | My Life as a Developer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Probably not the best title for this post, but one image will explain it:
Only the markers in the phone are shown, the user can move the phone frame and see others markers.
The main idea is to create">
<meta property="og:type" content="article">
<meta property="og:title" content="Google Maps, Angular and Draggable Frame">
<meta property="og:url" content="http://noamsh.com/2013/09/20/google-maps-angular-and-draggable-frame/">
<meta property="og:site_name" content="My Life as a Developer">
<meta property="og:description" content="Probably not the best title for this post, but one image will explain it:
Only the markers in the phone are shown, the user can move the phone frame and see others markers.
The main idea is to create">
<meta property="og:image" content="http://noamshemesh.files.wordpress.com/2013/09/screen-shot-2013-09-20-at-1-54-56-pm.png?w=300">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Google Maps, Angular and Draggable Frame">
<meta name="twitter:description" content="Probably not the best title for this post, but one image will explain it:
Only the markers in the phone are shown, the user can move the phone frame and see others markers.
The main idea is to create">
<meta name="twitter:creator" content="@[object Object]">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-52398580-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">My Life as a Developer</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">node, angular, etc...</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://noamsh.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-google-maps-angular-and-draggable-frame" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2013/09/20/google-maps-angular-and-draggable-frame/" class="article-date">
  <time datetime="2013-09-20T11:55:25.000Z" itemprop="datePublished">20 09 2013</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Angularjs/">Angular.js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Google Maps, Angular and Draggable Frame
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Probably not the best title for this post, but one image will explain it:</p>
<p><a href="http://noamshemesh.files.wordpress.com/2013/09/screen-shot-2013-09-20-at-1-54-56-pm.png" target="_blank" rel="external"><img src="http://noamshemesh.files.wordpress.com/2013/09/screen-shot-2013-09-20-at-1-54-56-pm.png?w=300" alt="Screen Shot 2013-09-20 at 1.54.56 PM"></a>Only the markers in the phone are shown, the user can move the phone frame and see others markers.</p>
<p>The main idea is to create a div that would update angular with its current position (and sizes, if not fixed), and then update the markers on the map to be visible if they are inside the frame, otherwise set them to be invisible.</p>
<p><a id="more"></a>An ideal angular library for google maps is <a href="https://github.com/nlaplante/angular-google-maps" target="_blank" rel="external">nlaplante’s angular-google-maps</a>. The library itself is very good, although it doesn’t export the google’s main map object, what I believe he did for a reason, encapsulation for that matter, and this is probably the correct way of doing it, but wasn’t enough for me. I understood that wrapping all the objects and the events that I need probably will get me nothing. So I <a href="https://github.com/noamshemesh/angular-google-maps" target="_blank" rel="external">forked</a> it, and also added padding to the “fit” functionality, and export the google’s markers objects too.</p>
<p>For the draggable functionality I use <a href="http://jqueryui.com/draggable/" target="_blank" rel="external">jquery-ui,</a> which I wasn’t familiar with, but it is easy to use and do what you want it to do.</p>
<p>Let’s start with some code, the main page that the user sees is index.jade, that using the <a href="http://jade-lang.com/" target="_blank" rel="external">jade</a> language, that is seamlessly compiled to html</p>
<p>index.jade:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre>#draggable(draggable, xpos=<span class="string">'xpos'</span>, ypos=<span class="string">'ypos'</span>)
  img(id=<span class="string">'phone'</span>)
google-map.map(center=&quot;center&quot;, fit=&quot;<span class="literal">true</span>&quot;, draggable=&quot;<span class="literal">true</span>&quot;, zoom=&quot;zoom&quot;, markers=&quot;markers&quot;, mark-click=&quot;<span class="literal">false</span>&quot;, map=&quot;map&quot;)
</pre></td></tr></table></figure>

<p>The first line of the index.jade is the definition of the phone frame that is draggable, you can see that there are 2 “draggable” elements, the first is the id of the object, that is needed for the jquery-ui in order to define it as draggable and for this css:</p>
<p>app.scss:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre>#draggable {
  height: 516px;
  width: 300px;
  z-index: 2;
  position: absolute;
  top: 0;
  left: 0;

  #phone {
    height: 516px;
    width: 300px;
    background-image: url(&quot;/img/android_frame.png&quot;);
    background-size: 300px 516px;
    background-repeat: no-repeat;
  }
}
</pre></td></tr></table></figure>

<p>Notice the z-index of the div.</p>
<p>Back to the draggable definition, the second draggable word, with the other attributes, are the interesting ones, they related directly to this angular directive:</p>
<p>controller.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre>app.directive(<span class="string">'draggable'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> {
    restrict: <span class="string">'A'</span>,
    link: <span class="function"><span class="keyword">function</span> <span class="params">(scope, element, attrs)</span> {</span>
      <span class="keyword">var</span> update = <span class="function"><span class="keyword">function</span> <span class="params">(event, ui)</span> {</span>
        scope.$<span class="built_in">eval</span>(attrs.xpos + <span class="string">'='</span> + ui.position.left);
        scope.$<span class="built_in">eval</span>(attrs.ypos + <span class="string">'='</span> + ui.position.top);
        scope.$apply();
      };
      <span class="keyword">var</span> lastUpdate = <span class="number">0</span>;
      <span class="keyword">var</span> updateEveryXMillis = <span class="function"><span class="keyword">function</span> <span class="params">(event, ui)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">new</span> <span class="built_in">Date</span>().getTime() - lastUpdate &gt;= <span class="number">100</span>) {
          update(event, ui);
          lastUpdate = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();
        }
      }

      $(<span class="string">'#draggable'</span>).draggable({
        cursor: &quot;drag&quot;,
        stop: update,
        drag: updateEveryXMillis
      });
    }
  };
});
</pre></td></tr></table></figure>

<p>The directive itself initialize the jquery-ui draggable functionality on the element, the element parameter of link function didn’t has the draggable method, causing <code>TypeError: Object [object Object] has no method &#39;draggable&#39;</code>. When calling to draggable method, I define what to do when the user drags and when he stops, the logic of these functions is simple, update xpos and ypos of the $scope (they are under the scope cause I bound them in the jade above), and now, all we have to do is to update the markers visibility:</p>
<p>controller.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="code"><pre><span class="keyword">var</span> app = angular.module(&quot;map&quot;, [&quot;google-maps&quot;]);
app.controller(<span class="string">'MapCtrl'</span>, [<span class="string">'$scope'</span>, <span class="string">'$http'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($scope, $http)</span> {</span>
  angular.extend($scope, {
    center: {
      latitude: <span class="number">0</span>,
      longitude: <span class="number">0</span>
    },
    markers: [],
    zoom: <span class="number">8</span>
  });

  <span class="function"><span class="keyword">function</span> <span class="title">getLocations</span><span class="params">()</span> {</span>
    $http.get(<span class="string">'/locations'</span>).success(<span class="function"><span class="keyword">function</span> <span class="params">(data)</span> {</span>
      <span class="keyword">var</span> markers = []
      _.forEach(data.locations, <span class="function"><span class="keyword">function</span> <span class="params">(location)</span> {</span>
        markers.push({ latitude: location.latitude, longitude: location.longitude, visible: <span class="literal">false</span> });
      });
      $scope.markers = markers;
    });
  }

  getLocations();
  setInterval(getLocations, <span class="number">5000</span>);

  <span class="keyword">var</span> phone = $(<span class="string">'#phone'</span>)
  <span class="keyword">var</span> phoneWidth = phone.width();
  <span class="keyword">var</span> phoneHeight = phone.height();

  <span class="function"><span class="keyword">function</span> <span class="title">updateMarkerVisibility</span><span class="params">(marker, xpos, ypos)</span> {</span>
    <span class="keyword">var</span> markerPoint = $scope.map.overlay.getProjection().
        fromLatLngToContainerPixel(marker.getPosition());
    marker.setVisible(markerPoint.x &gt;= xpos &amp;&amp; markerPoint.x &lt;= xpos + phoneWidth &amp;&amp;
        markerPoint.y &gt;= ypos &amp;&amp; markerPoint.y &lt;= ypos + phoneHeight);
  }

  $scope.$watch(<span class="string">'map._markers'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(newMarkers)</span> {</span>
    _.forEach(newMarkers, <span class="function"><span class="keyword">function</span> <span class="params">(marker)</span> {</span>
      updateMarkerVisibility(marker, $scope.xpos, $scope.ypos);
    })
  })

  $scope.$watch(<span class="string">'xpos'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(newValue, oldValue)</span> {</span>
    <span class="keyword">if</span> ($scope.map &amp;&amp; $scope.map._markers) {
      _.forEach($scope.map._markers, <span class="function"><span class="keyword">function</span> <span class="params">(marker)</span> {</span>
        updateMarkerVisibility(marker, newValue, $scope.ypos);
      })
    }
  })

  $scope.$watch(<span class="string">'ypos'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(newValue, oldValue)</span> {</span>
    <span class="keyword">if</span> ($scope.map &amp;&amp; $scope.map._markers) {
      _.forEach($scope.map._markers, <span class="function"><span class="keyword">function</span> <span class="params">(marker)</span> {</span>
        updateMarkerVisibility(marker, $scope.xpos, newValue);
      })
    }
  })
}]);
</pre></td></tr></table></figure>

<p>Here I watch the xpos, ypos of the scope and the markers of google’s map that have been updated when markers got updated in the interval function by the angular-google-maps library.<br>When any delegate of the watch function is called it decides if each marker need to be shown.<br>If you want to support zoom you need to watch its changes too.</p>
<p>The angular extend, is for the angular-google-maps library that mentioned above.</p>
<p>Don’t forget to tell angular what is your controller in the jade file.</p>
<p>Noam.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://noamsh.com/2013/09/20/google-maps-angular-and-draggable-frame/" data-id="af6fdr5n7csyqwe4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Draggable-div/">Draggable div</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Google-maps-overlay/">Google maps overlay</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Update-content-with-drag/">Update content with drag</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/01/04/sqlite-dal-for-android/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Sq Lite Dal for Android
        
      </div>
    </a>
  
  
    <a href="/2013/08/30/login-and-cookies/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Login and Cookies on Android</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Angularjs/">Angular.js</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Angularjs/Nodejs/">Node.js</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nodejs/">Node.js</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Draggable-div/">Draggable div</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Google-maps-overlay/">Google maps overlay</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Update-content-with-drag/">Update content with drag</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Draggable-div/" style="font-size: NaNpx;">Draggable div</a><a href="/tags/Google-maps-overlay/" style="font-size: NaNpx;">Google maps overlay</a><a href="/tags/Update-content-with-drag/" style="font-size: NaNpx;">Update content with drag</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2014/07/05/integration-coverage-istanbul/">Javascript Integration Tests Coverage With Istanbul</a>
          </li>
        
          <li>
            <a href="/2014/06/13/how-to-create-a-data-cluster-and-live-through-it/">How to Create a Data Cluster and Live Through It</a>
          </li>
        
          <li>
            <a href="/2014/01/04/sqlite-dal-for-android/">Sq Lite Dal for Android</a>
          </li>
        
          <li>
            <a href="/2013/09/20/google-maps-angular-and-draggable-frame/">Google Maps, Angular and Draggable Frame</a>
          </li>
        
          <li>
            <a href="/2013/08/30/login-and-cookies/">Login and Cookies on Android</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2014 Noam Shemesh<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>
  </div>
</body>
</html>